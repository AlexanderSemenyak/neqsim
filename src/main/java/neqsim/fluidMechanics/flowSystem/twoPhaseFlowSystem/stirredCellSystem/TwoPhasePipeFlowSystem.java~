package fluidMechanics.flowSystem.twoPhaseFlowSystem.twoPhasePipeFlowSystem;
//import guiAuto.*;
public class TwoPhasePipeFlowSystem extends fluidMechanics.flowSystem.twoPhaseFlowSystem.TwoPhaseFlowSystem {
    
    public TwoPhasePipeFlowSystem(){
    }
    
    public void createSystem(){
        // thermoSystem.init(1);
        flowLeg = new fluidMechanics.flowLeg.pipeLeg.PipeLeg[this.getNumberOfLegs()];
        
        for(int i=0;i<getNumberOfLegs();i++){
            flowLeg[i] = new fluidMechanics.flowLeg.pipeLeg.PipeLeg();
        }
        
        flowNode = new fluidMechanics.flowNode.FlowNodeInterface[totalNumberOfNodes];
        if(initFlowPattern.equals("stratified")) flowNode[0] = new fluidMechanics.flowNode.twoPhaseNode.twoPhasePipeFlowNode.StratifiedFlowNode(thermoSystem, equipmentGeometry[0]);
        else if(initFlowPattern.equals("annular")) flowNode[0] = new fluidMechanics.flowNode.twoPhaseNode.twoPhasePipeFlowNode.AnnularFlow(thermoSystem, equipmentGeometry[0]);
        else flowNode[0] = new fluidMechanics.flowNode.twoPhaseNode.twoPhasePipeFlowNode.StratifiedFlowNode(thermoSystem, equipmentGeometry[0]);
        
        flowNode[totalNumberOfNodes-1] =  flowNode[0].getNextNode();
        //
        super.createSystem();
        this.setNodes();
    }
    
    
    public void init(){
        for(int j = 0;j<getTotalNumberOfNodes();j++){
            flowNode[j].initFlowCalc();
            flowNode[j].init();
        }
        
        for(int j = 0;j<getTotalNumberOfNodes();j++){
            for(int phase=0; phase<2; phase++){
                flowNode[j].setVelocityOut(phase, this.flowNode[j].getVelocity(phase));
            }
        }
        
        for(int k = 1;k<getTotalNumberOfNodes();k++){
            for(int phase=0; phase<2; phase++){
                this.flowNode[k].setVelocityIn(phase, ((util.util.DoubleCloneable) this.flowNode[k-1].getVelocityOut(phase)));
            }
        }
    }
    
    public void solveSteadyState(int solverType){
        double[] times = {0.0};
        display = new fluidMechanics.util.fluidMechanicsVisualization.flowSystemVisualization.twoPhaseFlowVisualization.twoPhasePipeFlowVisualization.TwoPhasePipeFlowVisualization(this.getTotalNumberOfNodes(),1);
        getTimeSeries().setTimes(times);
        thermo.system.SystemInterface[] systems = {flowNode[0].getBulkSystem()};
        getTimeSeries().setInletThermoSystems(systems);
        getTimeSeries().setNumberOfTimeStepsInInterval(1);
        double[] outletFlowRates = {0.0, 0.0};
        getTimeSeries().setOutletMolarFlowRate(outletFlowRates);
        
        flowSolver = new fluidMechanics.flowSolver.twoPhaseFlowSolver.twoPhasePipeFlowSolver.TwoPhaseFixedStaggeredGridSolver(this, getSystemLength(), this.getTotalNumberOfNodes(), false);
        flowSolver.setSolverType(solverType);
        flowSolver.solveTDMA();
        getTimeSeries().init(this);
        display.setNextData(this);
    }
    
    public void solveTransient(int type){
        //   pipeSolver pipeSolve = new pipeSolver(this, getSystemLength(), getTotalNumberOfNodes());
        //   pipeSolve.solveTDMA();
    }
    
    
    
    public static void main(String[] args){
        // Initierer et nyt rørsystem
        fluidMechanics.flowSystem.FlowSystemInterface pipe = new TwoPhasePipeFlowSystem();
        
        // Definerer termodyanmikken5
        thermo.system.SystemInterface testSystem = new thermo.system.SystemSrkEos(295.3, 5.0);    // initierer et system som benytter SRK tilstandsligning
        // med trykk 305.3 K og 125 bar
        thermodynamicOperations.ThermodynamicOperations testOps = new thermodynamicOperations.ThermodynamicOperations(testSystem);                  // gjør termodyanmiske Flash rutiner tilgjengelige
        testSystem.addComponent("methane", 0.11152181, 0);
        //testSystem.addComponent("ethane", 0.0011152181, 0);
        testSystem.addComponent("water", 0.04962204876, 1);
        testSystem.setMixingRule(2);
        // benytter klassiske blandingsregler
        
        pipe.setInletThermoSystem(testSystem);                               // setter termodyanmikken for rørsystemet
        pipe.setNumberOfLegs(5);                                        // deler inn røret i et gitt antall legger
        pipe.setNumberOfNodesInLeg(10);                                 // setter antall nodepunkter (beregningspunkter/grid) pr. leg
        double[] height = {0,0,0,0,0,0};
        double[] length = {0.0, 1.7, 3.5, 5.0, 7.5, 10.4};
        double[] outerTemperature = {278.0, 278.0, 278.0, 278.0, 278.0, 278.0, 278.0, 275.0, 275.0, 275.0, 275.0};
        
        pipe.setLegHeights(height);                                     // setter inn høyde for hver leg-ende
        pipe.setLegPositions(length);                                  // setter avstand til hver leg-ende
        pipe.setLegOuterTemperatures(outerTemperature);
        
        fluidMechanics.geometryDefinitions.GeometryDefinitionInterface [] pipeGemometry = new fluidMechanics.geometryDefinitions.pipe.PipeData[6];    // Deffinerer geometrien for røret
        double[] pipeDiameter = {0.02588, 0.02588, 0.02588, 0.02588, 0.02588, 0.02588};
        for(int i=0;i<pipeDiameter.length;i++) pipeGemometry[i] = new fluidMechanics.geometryDefinitions.pipe.PipeData(pipeDiameter[i]);
        pipe.setEquipmentGeometry(pipeGemometry);                      // setter inn rørgeometrien for hver leg
        // utfører bergninger
        pipe.createSystem();
        pipe.init();
        
        pipe.solveSteadyState(2);
        // pipe.calcFluxes();
        //pipe.getDisplay().displayResult("temperature");
        pipe.getDisplay().createNetCdfFile("c:/temp5.nc");
        // pipe.displayResults();
        // testOps.TPflash();
        // testOps.displayResult();
    }
}