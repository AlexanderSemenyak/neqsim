/*
 * bubblePointFlash.java
 *
 * Created on 14. oktober 2000, 16:30
 */

package thermodynamicOperations.flashOps.saturationOps;


import thermodynamicOperations.*;
import thermo.system.*;
import thermo.component.*;

public class waterDewPointTemperatureFlash extends constantDutyTemperatureFlash{
    
    /** Creates new bubblePointFlash */
    public waterDewPointTemperatureFlash() {
    }
    
    public waterDewPointTemperatureFlash(SystemInterface system) {
        super(system);
    }
    
    
    public void run(){
        
        int iterations=0, maxNumberOfIterations = 15000;
        double yold=0, ytotal=1;
        double deriv=0, funk=0;
        double maxTemperature = 0, minTemperature= 1e6;
        system.init(0);
        
         system.display();
       
        system.setNumberOfPhases(2);
        
        for(int k=0;k<system.getPhases()[0].getNumberOfComponents();k++){
            if(system.getPhase(0).getComponent(k).getComponentName().equals("water") || system.getPhase(0).getComponent(k).getComponentName().equals("MEG")){
                system.setTemperature(system.getPhases()[0].getComponents()[k].getMeltingPointTemperature());
                for(int l=0;l<system.getPhases()[0].getNumberOfComponents();l++){
                    system.getPhase(1).getComponent(l).setx(1e-20);
                    System.out.println("here");
                }
                system.getPhase(1).getComponent(k).setx(1.0);
                system.init(1);
               // system.display();
                iterations=0;
                do{
                    funk=0;
                    deriv = 0.0;
                    iterations++;
                    system.init(3);
                    funk =  system.getPhases()[0].getComponents()[k].getz();
                    
                    for(int i=0;i<1;i++){
                        funk -= system.getPhases()[i].getBeta()*system.getPhases()[1].getComponents()[k].getFugasityCoeffisient()/system.getPhases()[i].getComponents()[k].getFugasityCoeffisient();
                        deriv -= system.getPhases()[i].getBeta()*(system.getPhases()[1].getComponents()[k].getFugasityCoeffisient()*Math.exp(system.getPhases()[i].getComponents()[k].getdfugdt())*-1.0/Math.pow(system.getPhases()[i].getComponents()[k].getFugasityCoeffisient(),2.0) + Math.exp(system.getPhases()[1].getComponents()[k].getdfugdt())/system.getPhases()[i].getComponents()[k].getFugasityCoeffisient());
                    }
                    System.out.println("funk " + funk);
                    
                    system.setTemperature(system.getTemperature() + 1000.0*funk);
                    
                    System.out.println("temp " + system.getTemperature());
                    //if(system.getPhase(0).getComponent(k).getComponentName().equals("MEG")) System.out.println("funk " + funk + " temp " + system.getTemperature());
                    
                }
                while(Math.abs(funk)>=0.0000001 && iterations<100000);
                
                //System.out.println("funk " + funk + k + " " + system.getTemperature());
                if(system.getTemperature()<minTemperature) minTemperature=system.getTemperature();
                if(system.getTemperature()>maxTemperature) maxTemperature=system.getTemperature();
            }
        }
        system.setTemperature(maxTemperature);
        //System.out.println("min freezing temp " + minTemperature);
        //System.out.println("max freezing temp " + maxTemperature);
    }
    
    public void printToFile(String name) {}
    
    
    
}
